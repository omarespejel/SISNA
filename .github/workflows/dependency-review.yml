name: Dependency Review

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Check dependency graph availability
        id: depgraph
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          status=$(gh api "repos/${{ github.repository }}" --jq '.security_and_analysis.dependency_graph.status // "unknown"' || echo "unknown")
          echo "status=$status" >> "$GITHUB_OUTPUT"
          if [[ "$status" != "enabled" ]]; then
            echo "::warning::Dependency graph is '$status'; skipping dependency review action."
          fi

      - name: Dependency Review
        if: steps.depgraph.outputs.status == 'enabled'
        uses: actions/dependency-review-action@46a3c492319c890177366b6ef46d6b4f89743ed4
        with:
          fail-on-severity: high

      - name: Dependency review skipped
        if: steps.depgraph.outputs.status != 'enabled'
        run: echo "Dependency graph is not enabled for this repository yet."
